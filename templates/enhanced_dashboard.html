{% extends "enhanced_base.html" %}

{% block page_title %}Healthcare Dashboard{% endblock %}
{% block page_subtitle %}Real-time overview of your healthcare operations{% endblock %}

{% block content %}
<!-- Real-time System Status Alert -->
<div class="alert alert-success border-0 shadow-sm mb-4" role="alert">
    <div class="d-flex align-items-center">
        <i class="fas fa-check-circle fs-4 me-3"></i>
        <div>
            <h6 class="alert-heading mb-1">System Status: All Systems Operational</h6>
                                <small class="mb-0">Last updated: <span id="last-updated">{{ current_time }}</span></small>
        </div>
    </div>
</div>

<!-- Key Performance Metrics -->
<div class="row g-4 mb-5">
    <div class="col-xl-3 col-md-6">
        <div class="metric-card">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="metric-value" id="total-patients">{{ metrics.total_patients or 0 }}</div>
                    <div class="metric-label">Total Patients</div>
                    <div class="metric-trend"><i class="fas fa-arrow-up"></i> +12% this month</div>
                </div>
                <i class="fas fa-user-injured fs-1 opacity-75"></i>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="metric-card warning">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="metric-value" id="active-alerts">{{ metrics.active_alerts or 0 }}</div>
                    <div class="metric-label">Active Clinical Alerts</div>
                    <div class="metric-trend"><i class="fas fa-arrow-down"></i> -8% today</div>
                </div>
                <i class="fas fa-exclamation-triangle fs-1 opacity-75"></i>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="metric-card success">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="metric-value">97.8%</div>
                    <div class="metric-label">System Uptime</div>
                    <div class="metric-trend"><i class="fas fa-arrow-up"></i> 99.9% SLA</div>
                </div>
                <i class="fas fa-heartbeat fs-1 opacity-75"></i>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="metric-card danger">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="metric-value">1.2s</div>
                    <div class="metric-label">Avg Response Time</div>
                    <div class="metric-trend"><i class="fas fa-arrow-down"></i> -15% improvement</div>
                </div>
                <i class="fas fa-tachometer-alt fs-1 opacity-75"></i>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Panel -->
<div class="card mb-5">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-lg-2 col-md-4 col-sm-6">
                <button class="btn btn-primary w-100 d-flex flex-column align-items-center p-3" onclick="openNewPatientModal()">
                    <i class="fas fa-user-plus fs-4 mb-2"></i>
                    <span>Add Patient</span>
                </button>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <button class="btn btn-success w-100 d-flex flex-column align-items-center p-3" onclick="createClinicalNote()">
                    <i class="fas fa-notes-medical fs-4 mb-2"></i>
                    <span>New Note</span>
                </button>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <button class="btn btn-warning w-100 d-flex flex-column align-items-center p-3" onclick="runDiagnostics()">
                    <i class="fas fa-search-plus fs-4 mb-2"></i>
                    <span>AI Diagnosis</span>
                </button>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <button class="btn btn-info w-100 d-flex flex-column align-items-center p-3" onclick="generateReport()">
                    <i class="fas fa-chart-bar fs-4 mb-2"></i>
                    <span>Generate Report</span>
                </button>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <button class="btn btn-secondary w-100 d-flex flex-column align-items-center p-3" onclick="uploadDocument()">
                    <i class="fas fa-upload fs-4 mb-2"></i>
                    <span>Upload Document</span>
                </button>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <button class="btn btn-dark w-100 d-flex flex-column align-items-center p-3" onclick="emergency()">
                    <i class="fas fa-ambulance fs-4 mb-2"></i>
                    <span>Emergency</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Main Dashboard Content -->
<div class="row g-4">
    <!-- Recent Patient Activity -->
    <div class="col-xl-8">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Patient Activity</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshActivity()">
                    <i class="fas fa-refresh"></i> Refresh
                </button>
            </div>
            <div class="card-body">
                <div id="recent-activity">
                    <div class="alert-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">Patient Admission: Sarah Brown</h6>
                                <p class="mb-1 text-muted">Emergency Department - Chest pain evaluation</p>
                                <small class="text-muted"><i class="fas fa-clock"></i> 15 minutes ago</small>
                            </div>
                            <span class="badge bg-info badge-status">New</span>
                        </div>
                    </div>
                    
                    <div class="alert-item warning">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">Critical Lab Result: Robert Davis</h6>
                                <p class="mb-1 text-muted">Troponin elevated - Cardiology consult recommended</p>
                                <small class="text-muted"><i class="fas fa-clock"></i> 32 minutes ago</small>
                            </div>
                            <span class="badge bg-warning badge-status">Alert</span>
                        </div>
                    </div>
                    
                    <div class="alert-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">Medication Review Completed: Alice Williams</h6>
                                <p class="mb-1 text-muted">Pharmacy reconciliation - 3 interactions identified</p>
                                <small class="text-muted"><i class="fas fa-clock"></i> 1 hour ago</small>
                            </div>
                            <span class="badge bg-success badge-status">Completed</span>
                        </div>
                    </div>
                    
                    <div class="alert-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">AI Diagnosis Generated: Patient ID 12847</h6>
                                <p class="mb-1 text-muted">Differential diagnosis for respiratory symptoms</p>
                                <small class="text-muted"><i class="fas fa-clock"></i> 2 hours ago</small>
                            </div>
                            <span class="badge bg-primary badge-status">AI</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- System Performance & Alerts -->
    <div class="col-xl-4">
        <div class="row g-4">
            <!-- Active Clinical Alerts -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Critical Alerts</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="text-danger"><i class="fas fa-circle"></i> High Priority</span>
                            <span class="badge bg-danger">2</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="text-warning"><i class="fas fa-circle"></i> Medium Priority</span>
                            <span class="badge bg-warning">5</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-info"><i class="fas fa-circle"></i> Low Priority</span>
                            <span class="badge bg-info">3</span>
                        </div>
                        <hr>
                        <button class="btn btn-sm btn-outline-primary w-100" onclick="window.location.href='/alerts'">
                            View All Alerts
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- System Performance -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>System Performance</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="small">CPU Usage</span>
                                <span class="small">23%</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: 23%"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="small">Memory Usage</span>
                                <span class="small">67%</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-warning" style="width: 67%"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="small">Database Load</span>
                                <span class="small">45%</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-info" style="width: 45%"></div>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <small class="text-muted">All systems operating normally</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row g-4 mt-4">
    <div class="col-xl-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Patient Volume Trends</h5>
            </div>
            <div class="card-body">
                <canvas id="patientVolumeChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-xl-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-doughnut me-2"></i>Alert Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="alertDistributionChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- New Patient Modal -->
<div class="modal fade" id="newPatientModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Add New Patient</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newPatientForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">First Name *</label>
                            <input type="text" class="form-control" name="first_name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Last Name *</label>
                            <input type="text" class="form-control" name="last_name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Date of Birth *</label>
                            <input type="date" class="form-control" name="date_of_birth" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Gender *</label>
                            <select class="form-select" name="gender" required>
                                <option value="">Select Gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" name="phone">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNewPatient()">Save Patient</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Dashboard-specific JavaScript
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadDashboardMetrics();
    startRealTimeUpdates();
});

function initializeCharts() {
    // Patient Volume Chart
    const patientVolumeCtx = document.getElementById('patientVolumeChart').getContext('2d');
    new Chart(patientVolumeCtx, {
        type: 'line',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                label: 'Patient Admissions',
                data: [45, 52, 38, 67, 73, 28, 31],
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Alert Distribution Chart
    const alertDistributionCtx = document.getElementById('alertDistributionChart').getContext('2d');
    new Chart(alertDistributionCtx, {
        type: 'doughnut',
        data: {
            labels: ['Critical', 'Warning', 'Info'],
            datasets: [{
                data: [2, 5, 3],
                backgroundColor: ['#dc2626', '#d97706', '#2563eb']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

async function loadDashboardMetrics() {
    try {
        const response = await axios.get('/api/analytics/dashboard');
        updateMetricsDisplay(response.data);
    } catch (error) {
        console.error('Error loading dashboard metrics:', error);
    }
}

function updateMetricsDisplay(data) {
    // Update patient count
    document.getElementById('total-patients').textContent = data.patient_demographics?.total_patients || 0;
    
    // Update alert count
    document.getElementById('active-alerts').textContent = data.alert_summary?.critical + data.alert_summary?.warning || 0;
    
    // Update timestamp
    document.getElementById('last-updated').textContent = new Date().toLocaleString();
}

function startRealTimeUpdates() {
    // Update metrics every 30 seconds
    setInterval(loadDashboardMetrics, 30000);
}

// Quick Actions
function openNewPatientModal() {
    new bootstrap.Modal(document.getElementById('newPatientModal')).show();
}

async function saveNewPatient() {
    const form = document.getElementById('newPatientForm');
    const formData = new FormData(form);
    const patientData = Object.fromEntries(formData);
    
    try {
        const response = await axios.post('/api/patients', patientData);
        showAlert('Patient created successfully!', 'success');
        bootstrap.Modal.getInstance(document.getElementById('newPatientModal')).hide();
        form.reset();
        loadDashboardMetrics();
    } catch (error) {
        showAlert('Error creating patient: ' + (error.response?.data?.detail || error.message), 'danger');
    }
}

function createClinicalNote() {
    window.location.href = '/clinical?action=new_note';
}

function runDiagnostics() {
    showAlert('AI Diagnostic Assistant launched', 'info');
    window.location.href = '/clinical?action=ai_diagnosis';
}

function generateReport() {
    window.location.href = '/analytics?action=generate_report';
}

function uploadDocument() {
    // Create file input dynamically
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.pdf,.doc,.docx,.jpg,.png,.dcm';
    input.onchange = handleFileUpload;
    input.click();
}

async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('patient_id', 'p001'); // Default patient for demo
    formData.append('document_type', 'general');
    
    try {
        showAlert('Uploading document...', 'info');
        const response = await axios.post('/api/upload/documents', formData);
        showAlert('Document uploaded successfully!', 'success');
    } catch (error) {
        showAlert('Error uploading document: ' + (error.response?.data?.detail || error.message), 'danger');
    }
}

function emergency() {
    showAlert('Emergency Protocol Activated', 'danger');
    // In a real system, this would trigger emergency workflows
    window.location.href = '/alerts?priority=critical';
}

function refreshActivity() {
    showLoading('recent-activity');
    setTimeout(() => {
        location.reload();
    }, 1000);
}
</script>
{% endblock %}